<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>GeoAR.js demo</title>
    <style>
    #mapDiv {
				font-size: 14px;
				line-height: 24px;
				/* float: left; */
				height: 60vh;
			}
    </style>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script type="text/javascript" src="https://api.tianditu.gov.cn/api?v=4.0&tk=f2b30f3a4b94a2bcdcf478381af577ff">
    <script type="text/javascript"
			src="https://lbs.tianditu.gov.cn/api/js4.0/opensource/openlibrary/ImageOverlay.js"></script>
  </head>

  <body>
    <div id="mapDiv"></div>
		<div>
			<div>
				<input type="button" onClick="searchDrivingRoute()" value="驾车路线搜索" />
				<input type="text" id="startPoint" value="我的位置" />
				<input type="button" value="搜索" onclick="searchStart();" />
				<input type="text" id="endPoint" value="河北师范大学北门" />
				<input type="button" value="搜索" onclick="searchEnd();" />
				<!-- <input type="button" value="导航开始" onclick="h5Position()" /> -->
				<div id="demo"></div>
				alpha:<span id="alpha"></span><br />
				beta:<span id="beta"></span><br />
				gamma:<span id="gamma"></span><br />
			</div>
			<br />
		</div>
    <a-scene
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
    >
      <a-text
        value="This content will always face you."
        look-at="[gps-camera]"
        scale="120 120 120"
        gps-entity-place="latitude: <add-your-latitude>; longitude: <add-your-longitude>;"
      ></a-text>
      <a-camera gps-camera rotation-reader> </a-camera>
    </a-scene>
    
    <script>
      var map; //地图对象
			var zoom = 16; //地图级别
			var drivingRoute; //驾车路线规划对象
			var obj; //搜索结果
			var startLngLat; //起点经纬度
			var endLngLat; //终点经纬度
			var startTool; //起点标注工具
			var endTool; //终点标注工具
			var startIcon = "http://lbs.tianditu.gov.cn/images/bus/start.png"; //起点图标
			var endIcon = "http://lbs.tianditu.gov.cn/images/bus/end.png"; //终点图标
			var infoWin = null;
			var geoCoderStart;
			var myLocation = {
				lon: null,
				lat: null
			};
			var geoCoderEnd;

			function onLoad() {
				//初始化地图对象
				map = new T.Map("mapDiv");
				//设置显示地图的中心点和级别
				map.centerAndZoom(new T.LngLat(114.51521121650413, 37.99539539571783), zoom);
				var config = {
					policy: 0, //驾车策略
					onSearchComplete: searchRouteResult //检索完成后的回调函数
				};
				drivingRoute = new T.DrivingRoute(map, config);

				geoCoderStart = new T.Geocoder();
				geoCoderEnd = new T.Geocoder();

				h5Position()

				if (window.DeviceOrientationEvent) {
					window.addEventListener('deviceorientation', function(event) {
						var a = document.getElementById('alpha'),
							b = document.getElementById('beta'),
							g = document.getElementById('gamma'),
							alpha = event.alpha,
							beta = event.beta,
							gamma = event.gamma;

						a.innerHTML = Math.round(alpha);
						b.innerHTML = Math.round(beta);
						g.innerHTML = Math.round(gamma);


					})
				}
			}

			function searchDrivingRoute() {
				h5Position();
				//清空显示列表
				document.getElementById("resultDiv").innerHTML = "";
				//清空地图
				map.clearOverLays();
				//起点经纬度
				if (document.getElementById('startPoint').value == '我的位置') {
					startLngLat = new T.LngLat(myLocation.lon, myLocation.lat);
				} else {
					startLngLat = new T.LngLat(geoCoderStart.result.location.lon, geoCoderStart.result.location
						.lat);
				}
				//终点经纬度
				endLngLat = new T.LngLat(geoCoderEnd.result.location.lon, geoCoderEnd.result.location.lat);


				//设置驾车策略
				drivingRoute.setPolicy(3);
				//驾车路线搜索
				drivingRoute.search(startLngLat, endLngLat);
			}

			function searchRouteResult(result) {
				//添加起始点
				createStartMarker(result);
				obj = result;
				//显示驾车线路
				createRoute(plan.getPath());

				console.log(plan)
				//显示最佳级别
				map.setViewport(plan.getPath());
				}

			function createRoute(lnglats, lineColor) {
				//创建线对象
				var line = new T.Polyline(lnglats, {
					color: "#2C64A7",
					weight: 10,
					opacity: 0.8
				});
				//向地图上添加线
				map.addOverLay(line);
			}

			function searchPOIResult(result) {
				if (result.getStatus() == 0) {
					map.panTo(result.getLocationPoint(), 16);
					var marker = new T.Marker(result.getLocationPoint());
					map.addOverLay(marker);
				} else {
					alert(result.getMsg());
				}
			}

			function searchStart() {
				if (document.getElementById('startPoint').value == '我的位置') {
					return new Promise((resolve, reject) => {
						//resolve({ bol: true, longitude: 116.104904, latitude: 24.277311 })
						if (navigator.geolocation) {
							let params = {
								enableHighAccuracy: true, //表示是否允许使用高精度
								geocode: true //是否解析地址信息。解析的地址信息保存到Position对象的address、addresses属性中
								//详细的参数可以参考 https://blog.csdn.net/weixin_30408739/article/details/99012875
							}
							navigator.geolocation.getCurrentPosition((position) => {
								let longitude = position.coords.longitude //经度
								let latitude = position.coords.latitude //纬度
								myLocation.lon = longitude;
								myLocation.lat = latitude;
								var marker = new T.Marker(new T.LngLat(longitude,latitude));
								map.addOverLay(marker);
								
	
								resolve({
										bol: true,
										longitude: longitude,
										latitude: latitude
									}),
									map.panTo(new T.LngLat(longitude, latitude), 16);

							}, (error) => {
								reject({
									bol: false,
									msg: '获取经纬度失败'
								})
							});
						} else {
							reject({
								bol: false,
								msg: '您的设备不支持卫星定位,请手动选择'
							})
						}
					})
				} else {
					geoCoderStart.getPoint(document.getElementById('startPoint').value, searchPOIResult);
					// var data;
					// console.log(searchPOIResult(data))
					console.log(geoCoderStart)
				}
			};

			function searchEnd() {
				map.clearOverLays();
				geoCoderEnd.getPoint(document.getElementById('endPoint').value, searchPOIResult);
			}
			//添加起始点
			function createStartMarker(result) {
				var startMarker = new T.Marker(result.getStart(), {
					icon: new T.Icon({
						iconUrl: startIcon,
						iconSize: new T.Point(44, 34),
						iconAnchor: new T.Point(12, 31)
					})
				});
				map.addOverLay(startMarker);
				var endMarker = new T.Marker(result.getEnd(), {
					icon: new T.Icon({
						iconUrl: endIcon,
						iconSize: new T.Point(44, 34),
						iconAnchor: new T.Point(12, 31)
					})
				});
				map.addOverLay(endMarker);
			}

			//定位关键点
			function showPosition(lng, lat, des) {
				if (infoWin) {
					map.removeOverLay(infoWin);
					infoWin = null;
				}
				var lnglat = new T.LngLat(lng, lat);
				infoWin = new T.InfoWindow(des, new T.Point([0, 0]));
				infoWin.setLngLat(lnglat);
				map.addOverLay(infoWin);
			}

			function h5Position() {

				return new Promise((resolve, reject) => {
					//resolve({ bol: true, longitude: 116.104904, latitude: 24.277311 })
					if (navigator.geolocation) {
						let params = {
							enableHighAccuracy: true, //表示是否允许使用高精度
							geocode: true //是否解析地址信息。解析的地址信息保存到Position对象的address、addresses属性中
							//详细的参数可以参考 https://blog.csdn.net/weixin_30408739/article/details/99012875
						}
						navigator.geolocation.watchPosition((position) => {
							var longitude = position.coords.longitude //经度
							var latitude = position.coords.latitude //纬度

							document.getElementById('demo').innerHTML = longitude + ',' +
								latitude;
							
							var icon = new T.Icon({
								iconUrl: "compass.jpg",
								iconSize: new T.Point(19, 27),
								iconAnchor: new T.Point(10, 25)
							});
							//向地图上添加自定义标注
							var marker = new T.Marker(new T.LngLat(longitude, latitude), {
								icon: icon
							});
							
							map.addOverLay(marker);
							resolve({
								bol: true,
								longitude: longitude,
								latitude: latitude
							})
							return longitude, latitude
						}, (error) => {
							reject({
								bol: false,
								msg: '获取经纬度失败'
							})
						});

					} else {
						reject({
							bol: false,
							msg: '您的设备不支持卫星定位,请手动选择'
						})
					}
				})
			}
    </script>
  </body>
</html>
